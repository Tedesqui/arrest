<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Reconhecimento Facial no Navegador</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body { margin:0; padding:0; font-family:Arial; background:#000; color:#fff; text-align:center; }
    video { width:100%; max-width:600px; border-radius:12px; }
    #info { margin-top:10px; padding:15px; background:rgba(0,0,0,0.7); border-radius:10px; width:90%; max-width:600px; font-size:18px; }
    #zoomBtn { margin-top:15px; padding:15px 25px; border-radius:12px; background:#007bff; border:none; color:#fff; font-size:20px; cursor:pointer; }
    #zoomBtn:hover { background:#0056b3; }
  </style>
</head>
<body>

  <h2>Reconhecimento Facial Local</h2>
  <video id="video" autoplay muted playsinline></video>
  <div id="info">Aguardando reconhecimento...</div>
  <button id="zoomBtn">Zoom: 1X</button>

  <script>
    const video = document.getElementById('video');
    const info = document.getElementById('info');
    const zoomBtn = document.getElementById('zoomBtn');
    let currentZoom = 1;
    const zoomLevels = [1, 2, 3];

    const peopleData = {
      "Mariana Ximenes": { name: "Mariana Ximenes", description: "Atriz brasileira." },
      "Morgan Freeman": { name: "Morgan Freeman", description: "Ator e narrador americano." },
      "Jean Tedesqui": { name: "Jean Tedesqui", description: "Profissional de tecnologia." }
    };

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" }, width: { ideal: 640 }, height: { ideal: 480 } }
      });
      video.srcObject = stream;
      const [track] = stream.getVideoTracks();
      video.track = track;
    }

    function toggleZoom() {
      currentZoom = zoomLevels[(zoomLevels.indexOf(currentZoom) + 1) % zoomLevels.length];
      zoomBtn.textContent = `Zoom: ${currentZoom}X`;
      const capabilities = video.track.getCapabilities();
      if (capabilities.zoom) {
        video.track.applyConstraints({ advanced: [{ zoom: currentZoom }] });
      }
    }

    zoomBtn.addEventListener('click', toggleZoom);

    async function loadModels() {
      await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models/');
      await faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models/');
      await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models/');
    }

    async function createLabeledDescriptors() {
      const labels = ["Mariana Ximenes", "Morgan Freeman", "Jean Tedesqui"];
      return Promise.all(labels.map(async label => {
        const descriptors = [];
        for (let i = 1; i <= 10; i++) {
          try {
            const img = await faceapi.fetchImage(`images/${label}/${i}.jpg`);
            const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
            if (detection) descriptors.push(detection.descriptor);
          } catch (e) {
            console.warn(`Erro carregando imagem: images/${label}/${i}.jpg`);
          }
        }
        return new faceapi.LabeledFaceDescriptors(label, descriptors);
      }));
    }

    async function startRecognition() {
      const labeledDescriptors = await createLabeledDescriptors();
      const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
      const canvas = faceapi.createCanvasFromMedia(video);
      document.body.append(canvas);

      const displaySize = { width: video.width, height: video.height };
      faceapi.matchDimensions(canvas, displaySize);

      setInterval(async () => {
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
        const resizedDetections = faceapi.resizeResults(detections, displaySize);

        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

        const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

        let recognized = false;
        results.forEach((result, i) => {
          const box = resizedDetections[i].detection.box;
          const label = result.label;
          const person = peopleData[label];
          if (person) {
            info.innerHTML = `<strong>${person.name}</strong><br>${person.description}`;
            recognized = true;
            const drawBox = new faceapi.draw.DrawBox(box, { label: person.name });
            drawBox.draw(canvas);
          }
        });

        if (!recognized) info.textContent = 'Nenhuma pessoa reconhecida.';
      }, 1000);
    }

    async function main() {
      await loadModels();
      await setupCamera();
      await startRecognition();
    }

    main();
  </script>
</body>
</html>
